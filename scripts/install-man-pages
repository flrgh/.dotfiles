#!/usr/bin/env bash

set -euo pipefail

readonly MAN=$HOME/.local/share/man
readonly MAN1="$MAN"/man1


setup() {
    mkdir -p "$MAN" "$MAN1"
}

exists() {
    command -v "$@" &>/dev/null
}

log() {
    echo "$@"
}


add-man-path() {
    local -r mp=${1:?}

    if [[ ! -d $mp ]]; then
        echo "error: $mp not found or not a directory"
        return 1
    fi

    local rel subdir

    shopt -s failglob

    for subdir in "$mp"/man[0-9]; do
        rel=${MAN}${subdir#"$mp"}
        ./scripts/symlink-tree "$subdir" "$rel"
    done
}

add-man-1() {
    if (( $# == 0 )); then
        echo "error: no paths provided"
        return 1
    fi

    local p
    for p in "$@"; do
        if [[ ! -e $p ]]; then
            echo "error: path $p does not exist"
            return 1
        fi
    done

    install \
        --mode 0664 \
        --preserve-timestamps \
        --target-directory "$MAN1" \
        "$@"
}

man-1-from-cmd() {
    local -r bin=${1:-}

    if ! exists "$bin"; then
        echo "$bin not found"
        return
    fi

    "$@" > "${MAN1}/${bin##*/}.1"
}

# chmod 0664 all regular files (not symlinks) in the man page dirs
fix-perms() {
    shopt -s failglob
    local f
    for f in "${MAN}"/man[1-9]/*; do
        if [[ -f $f && ! -L $f ]]; then
            chmod 0664 "$f"
        fi
    done
}

_git_cliff() {
    if ! exists git-cliff; then
        log "git-cliff is not installed"
        return
    fi

    local where; where=$(mise where git-cliff)
    shopt -s failglob

    local man=("${where}"/*/man/git-cliff.1)
    add-man-1 "${man[0]}"
}

_fzf() {
    if ! exists fzf; then
        log "fzf not found"
        return
    fi

    local bin; bin=$(mise which fzf)

    # -R tells `man` to re-encode the input rather than formatting it for display
    MANOPT='-R' "$bin" --man > "$MAN1/fzf.1"
}

_gh() {
    if ! exists gh; then
        log "gh is not installed"
        return
    fi

    local where; where=$(mise where gh)
    shopt -s failglob
    local man=("${where}"/*/share/man)

    add-man-path "${man[0]}"
}

_ripgrep() {
    if ! exists rg; then
        log "ripgrep (rg) not found"
        return
    fi

    local rg; rg=$(mise which rg)
    man-1-from-cmd "$rg" --generate man
}

_rustup() {
    if ! exists rustup; then
        log "rustup not found"
        return
    fi

    local active
    active=$(rustup show active-toolchain | awk '{print $1}')

    local tc
    tc=${RUSTUP_HOME:?}/toolchains/${active:?}

    if [[ -d ${tc}/share/man ]]; then
        add-man-path "${tc}/share/man"
    fi
}

_node() {
    local node; node=$(mise where node)

    if [[ -d $node/share/man ]]; then
        add-man-path "${node}/share/man"
    fi
}

_npm() {
    if [[ -d $HOME/.local/lib/node_modules/npm/man ]]; then
        add-man-path "$HOME/.local/lib/node_modules/npm/man"
    fi
}

_fd() {
    if ! exists fd; then
        log "fd not found"
    fi

    local bin; bin=$(mise which fd)
    add-man-1 "${bin}.1"
}

_nfpm() {
    if ! exists nfpm; then
        log "nfpm not found"
    fi

    local where; where=$(mise where nfpm)

    shopt -s failglob
    add-man-1 "${where}"/manpages/*
}

_python() {
    local where; where=$(mise where python)
    add-man-path "$where"/share/man
}

_http() {
    if ! exists http && exists xh; then
        alias http=xh
    fi

    man-1-from-cmd http --generate man
}

_xh() {
    man-1-from-cmd xh --generate man
}


main() {
    setup

    _fd
    _fzf
    _gh
    _git_cliff
    _http
    _nfpm
    _node
    _npm
    _python
    _ripgrep
    _rustup
    _xh

    fix-perms
}

main "$@"
