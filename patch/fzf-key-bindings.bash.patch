--- key-bindings.bash	2025-11-03 16:32:22.297953434 -0800
+++ new-key-bindings.bash	2025-11-03 16:35:10.482348493 -0800
@@ -1,122 +1,110 @@
-### key-bindings.bash ###
-#     ____      ____
-#    / __/___  / __/
-#   / /_/_  / / /_
-#  / __/ / /_/ __/
-# /_/   /___/_/ key-bindings.bash
-#
-# - $FZF_TMUX_OPTS
-# - $FZF_CTRL_T_COMMAND
-# - $FZF_CTRL_T_OPTS
-# - $FZF_CTRL_R_COMMAND
-# - $FZF_CTRL_R_OPTS
-# - $FZF_ALT_C_COMMAND
-# - $FZF_ALT_C_OPTS
-
-if [[ $- =~ i ]]; then
-
-
-# Key bindings
-# ------------
-
-#----BEGIN shfmt
-#----BEGIN INCLUDE common.sh
-# NOTE: Do not directly edit this section, which is copied from "common.sh".
-# To modify it, one can edit "common.sh" and run "./update.sh" to apply
-# the changes. See code comments in "common.sh" for the implementation details.
-
+declare -g __fzf_defaults__
+# shellcheck disable=SC2206
 __fzf_defaults() {
-  printf '%s\n' "--height ${FZF_TMUX_HEIGHT:-40%} --min-height 20+ --bind=ctrl-z:ignore $1"
-  command cat "${FZF_DEFAULT_OPTS_FILE-}" 2> /dev/null
-  printf '%s\n' "${FZF_DEFAULT_OPTS-} $2"
-}
+    declare -g __fzf_defaults__=""
+
+    local -a opts=(
+        "--height=${FZF_TMUX_HEIGHT:-40%}"
+        "--min-height=20+"
+        "--bind=ctrl-z:ignore"
+    )
+
+    local arg
+    while (( $# )); do
+        arg=$1
+        shift
+
+        case $arg in
+            --) break;;
+            '') continue;;
+            *) opts+=("$arg");;
+        esac
+    done
 
-__fzf_exec_awk() {
-  if [[ -z ${__fzf_awk-} ]]; then
-    __fzf_awk=awk
-    if [[ $OSTYPE == solaris* && -x /usr/xpg4/bin/awk ]]; then
-      __fzf_awk=/usr/xpg4/bin/awk
-    elif command -v mawk > /dev/null 2>&1; then
-      local n x y z d
-      IFS=' .' read -r n x y z d <<< $(command mawk -W version 2> /dev/null)
-      [[ $n == mawk ]] && ((d >= 20230302 && (x * 1000 + y) * 1000 + z >= 1003004)) && __fzf_awk=mawk
+    if [[ -n ${FZF_DEFAULT_OPTS_FILE:-} && -f ${FZF_DEFAULT_OPTS_FILE} ]]; then
+        local -r -i offset=$(( ${#opts[@]} + 1 ));
+        builtin mapfile -t \
+            -O "$offset" \
+            opts \
+        <"$FZF_DEFAULT_OPTS_FILE"
     fi
-  fi
-  LC_ALL=C exec "$__fzf_awk" "$@"
-}
-#----END INCLUDE
 
-__fzf_select__() {
-  FZF_DEFAULT_COMMAND=${FZF_CTRL_T_COMMAND:-} \
-    FZF_DEFAULT_OPTS=$(__fzf_defaults "--reverse --walker=file,dir,follow,hidden --scheme=path" "${FZF_CTRL_T_OPTS-} -m") \
-    FZF_DEFAULT_OPTS_FILE='' $(__fzfcmd) "$@" |
-    while read -r item; do
-      printf '%q ' "$item" # escape special chars
+    if [[ -n ${FZF_DEFAULT_OPTS:-} ]]; then
+        opts+=( $FZF_DEFAULT_OPTS )
+    fi
+
+    while (( $# )); do
+        arg=$1
+        shift
+
+        case $arg in
+            '') continue;;
+            *) opts+=("$arg");;
+        esac
     done
-}
 
-__fzfcmd() {
-  [[ -n ${TMUX_PANE-} ]] && { [[ ${FZF_TMUX:-0} != 0 ]] || [[ -n ${FZF_TMUX_OPTS-} ]]; } &&
-    echo "fzf-tmux ${FZF_TMUX_OPTS:--d${FZF_TMUX_HEIGHT:-40%}} -- " || echo "fzf"
+    printf -v __fzf_defaults__ "%s" "${opts[*]}"
 }
 
-fzf-file-widget() {
-  local selected="$(__fzf_select__ "$@")"
-  READLINE_LINE="${READLINE_LINE:0:READLINE_POINT}$selected${READLINE_LINE:READLINE_POINT}"
-  READLINE_POINT=$((READLINE_POINT + ${#selected}))
+__fzf_select__() {
+    __fzf_defaults \
+        --reverse \
+        --walker=file,dir,follow,hidden \
+        --scheme=path \
+        -- \
+        "${FZF_CTRL_T_OPTS-}" \
+        -m
+
+    FZF_DEFAULT_COMMAND=${FZF_CTRL_T_COMMAND:-} \
+    FZF_DEFAULT_OPTS="$__fzf_defaults__" \
+    FZF_DEFAULT_OPTS_FILE='' \
+    fzf "$@" | while read -r item; do
+        printf '%q ' "$item" # escape special chars
+    done
 }
 
-__fzf_cd__() {
-  local dir
-  dir=$(
-    FZF_DEFAULT_COMMAND=${FZF_ALT_C_COMMAND:-} \
-      FZF_DEFAULT_OPTS=$(__fzf_defaults "--reverse --walker=dir,follow,hidden --scheme=path" "${FZF_ALT_C_OPTS-} +m") \
-      FZF_DEFAULT_OPTS_FILE='' $(__fzfcmd)
-  ) && printf 'builtin cd -- %q' "$(builtin unset CDPATH && builtin cd -- "$dir" && builtin pwd)"
-}
+fzf-file-widget() {
+    local selected="$(__fzf_select__ "$@")"
+    READLINE_LINE="${READLINE_LINE:0:READLINE_POINT}$selected${READLINE_LINE:READLINE_POINT}"
+    READLINE_POINT=$((READLINE_POINT + ${#selected}))
+}
+
+__fzf_lua_history=${HOME}/.local/libexec/fzf-lua-history
+
+__fzf_history__() {
+    # TODO: replace this with new command substitution
+    local len
+    len=$(HISTTIMEFORMAT='' builtin history 1)
+    local -i n=${len%% *}
+
+    __fzf_defaults \
+        -- \
+        -n2..,.. \
+        --scheme=history \
+        --bind=ctrl-r:toggle-sort,alt-r:toggle-raw \
+        --wrap-sign "'"$'\t'"↳ '" \
+        --highlight-line \
+        "${FZF_CTRL_R_OPTS-}" \
+        +m \
+        --read0
 
-if command -v perl > /dev/null; then
-  __fzf_history__() {
-    local output script
-    script='BEGIN { getc; $/ = "\n\t"; $HISTCOUNT = $ENV{last_hist} + 1 } s/^[ *]//; s/\n/\n\t/gm; print $HISTCOUNT - $. . "\t$_" if !$seen{$_}++'
+    local output
     output=$(
-      set +o pipefail
-      builtin fc -lnr -2147483648 |
-        last_hist=$(HISTTIMEFORMAT='' builtin history 1) command perl -n -l0 -e "$script" |
-        FZF_DEFAULT_OPTS=$(__fzf_defaults "" "-n2..,.. --scheme=history --bind=ctrl-r:toggle-sort,alt-r:toggle-raw --wrap-sign '"$'\t'"↳ ' --highlight-line ${FZF_CTRL_R_OPTS-} +m --read0") \
-        FZF_DEFAULT_OPTS_FILE='' $(__fzfcmd) --query "$READLINE_LINE"
-    ) || return
-    READLINE_LINE=$(command perl -pe 's/^\d*\t//' <<< "$output")
-    if [[ -z $READLINE_POINT ]]; then
-      echo "$READLINE_LINE"
-    else
-      READLINE_POINT=0x7fffffff
-    fi
-  }
-else # awk - fallback for POSIX systems
-  __fzf_history__() {
-    local output script
-    [[ $(HISTTIMEFORMAT='' builtin history 1) =~ [[:digit:]]+ ]] # how many history entries
-    script='function P(b) { ++n; sub(/^[ *]/, "", b); if (!seen[b]++) { printf "%d\t%s%c", '$((BASH_REMATCH + 1))' - n, b, 0 } }
-    NR==1 { b = substr($0, 2); next }
-    /^\t/ { P(b); b = substr($0, 2); next }
-    { b = b RS $0 }
-    END { if (NR) P(b) }'
-    output=$(
-      set +o pipefail
-      builtin fc -lnr -2147483648 2> /dev/null | # ( $'\t '<lines>$'\n' )* ; <lines> ::= [^\n]* ( $'\n'<lines> )*
-        __fzf_exec_awk "$script" |               # ( <counter>$'\t'<lines>$'\000' )*
-        FZF_DEFAULT_OPTS=$(__fzf_defaults "" "-n2..,.. --scheme=history --bind=ctrl-r:toggle-sort,alt-r:toggle-raw --wrap-sign '"$'\t'"↳ ' --highlight-line ${FZF_CTRL_R_OPTS-} +m --read0") \
-        FZF_DEFAULT_OPTS_FILE='' $(__fzfcmd) --query "$READLINE_LINE"
+        set +o pipefail
+        builtin fc -lnr -2147483648 2>/dev/null \
+            | "$__fzf_lua_history" "$n" \
+            | FZF_DEFAULT_OPTS="$__fzf_defaults__" \
+            FZF_DEFAULT_OPTS_FILE='' \
+            fzf --query "$READLINE_LINE"
     ) || return
+
     READLINE_LINE=${output#*$'\t'}
     if [[ -z $READLINE_POINT ]]; then
-      echo "$READLINE_LINE"
+        echo "$READLINE_LINE"
     else
-      READLINE_POINT=0x7fffffff
+        READLINE_POINT=0x7fffffff
     fi
-  }
-fi
+}
 
 # Required to refresh the prompt after fzf
 bind -m emacs-standard '"\er": redraw-current-line'
@@ -125,49 +113,14 @@
 bind -m vi-insert '"\C-z": emacs-editing-mode'
 bind -m emacs-standard '"\C-z": vi-editing-mode'
 
-if ((BASH_VERSINFO[0] < 4)); then
-  # CTRL-T - Paste the selected file path into the command line
-  if [[ ${FZF_CTRL_T_COMMAND-x} != "" ]]; then
-    bind -m emacs-standard '"\C-t": " \C-b\C-k \C-u`__fzf_select__`\e\C-e\er\C-a\C-y\C-h\C-e\e \C-y\ey\C-x\C-x\C-f\C-y\ey\C-_"'
-    bind -m vi-command '"\C-t": "\C-z\C-t\C-z"'
-    bind -m vi-insert '"\C-t": "\C-z\C-t\C-z"'
-  fi
-
-  # CTRL-R - Paste the selected command from history into the command line
-  if [[ ${FZF_CTRL_R_COMMAND-x} != "" ]]; then
-    if [[ -n ${FZF_CTRL_R_COMMAND-} ]]; then
-      echo "warning: FZF_CTRL_R_COMMAND is set to a custom command, but custom commands are not yet supported for CTRL-R" >&2
-    fi
-    bind -m emacs-standard '"\C-r": "\C-e \C-u\C-y\ey\C-u`__fzf_history__`\e\C-e\er"'
-    bind -m vi-command '"\C-r": "\C-z\C-r\C-z"'
-    bind -m vi-insert '"\C-r": "\C-z\C-r\C-z"'
-  fi
-else
-  # CTRL-T - Paste the selected file path into the command line
-  if [[ ${FZF_CTRL_T_COMMAND-x} != "" ]]; then
+# CTRL-T - Paste the selected file path into the command line
+if [[ ${FZF_CTRL_T_COMMAND-x} != "" ]]; then
     bind -m emacs-standard -x '"\C-t": fzf-file-widget'
     bind -m vi-command -x '"\C-t": fzf-file-widget'
     bind -m vi-insert -x '"\C-t": fzf-file-widget'
-  fi
-
-  # CTRL-R - Paste the selected command from history into the command line
-  if [[ ${FZF_CTRL_R_COMMAND-x} != "" ]]; then
-    if [[ -n ${FZF_CTRL_R_COMMAND-} ]]; then
-      echo "warning: FZF_CTRL_R_COMMAND is set to a custom command, but custom commands are not yet supported for CTRL-R" >&2
-    fi
-    bind -m emacs-standard -x '"\C-r": __fzf_history__'
-    bind -m vi-command -x '"\C-r": __fzf_history__'
-    bind -m vi-insert -x '"\C-r": __fzf_history__'
-  fi
 fi
 
-# ALT-C - cd into the selected directory
-if [[ ${FZF_ALT_C_COMMAND-x} != "" ]]; then
-  bind -m emacs-standard '"\ec": " \C-b\C-k \C-u`__fzf_cd__`\e\C-e\er\C-m\C-y\C-h\e \C-y\ey\C-x\C-x\C-d\C-y\ey\C-_"'
-  bind -m vi-command '"\ec": "\C-z\ec\C-z"'
-  bind -m vi-insert '"\ec": "\C-z\ec\C-z"'
-fi
-#----END shfmt
-
-fi
-### end: key-bindings.bash ###
+# CTRL-R - Paste the selected command from history into the command line
+bind -m emacs-standard -x '"\C-r": __fzf_history__'
+bind -m vi-command -x '"\C-r": __fzf_history__'
+bind -m vi-insert -x '"\C-r": __fzf_history__'
